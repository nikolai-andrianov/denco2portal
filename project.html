<!DOCTYPE html>
<html lang="en">
<head>
	
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	
	<title>Denmark's CO2 Portal - Stenlille</title>
	
	<!-- Add Leaflet classes -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

	<!-- Add Metro UI	--> 		
    <link rel="stylesheet" href="https://cdn.metroui.org.ua/current/metro.css">
	
	<!-- Add Metro icons -->
	<link href="https://metroui.org.ua/v2/css/iconFont.css" rel="stylesheet">
	
	<!-- Include jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

 
	<style>

		/* Change the html body to be a grid with 4 rows */
		body {
		  margin: 0;
		  height: 100vh;
		  display: grid;
		  grid-template-columns: 1fr;
		  grid-template-rows   : 75px 0.75fr 0.25fr 75px;
		  grid-template-areas: 
			"hd" 
			"cn" 
			"ct"
			"ft";
		  gap: 3px;
		}

		.header {
		  grid-area: hd;
		}

		.center {
		  grid-area: cn;
		}
		
		.control {
		  grid-area: ct;
		}

		/* line-height: 75px; matches the height of the 3rd row for vertically aligned text */
		.footer {
		  grid-area: ft;
		  line-height: 75px;
		  text-align: center;
		}

	</style>
	
</head> 

<body>

	<!-- Add Metro UI 	-->
	<script src="https://cdn.metroui.org.ua/current/metro.js"></script>

	<!-- Header -->
	<script src="./header.js"></script>	
	
	<!-- A list of Stenlille wells with their coordinates -->
	<script src="./stenlille/stenlille_wells.js"></script>
		
	<!-- dates_snapshots.js contains the list of dates and solution snapshots -->
	<script src="./stenlille/dates_snapshots.js"></script>
		
	<!-- Utilitary functions -->
	<script src="./utils.js"></script>
	
	<!-- First define the time menu for snapshots so it will be available below -->
	
	<div id="ctrl" class="control">
	<div class="container">	
	
		<!--  Menu with available time instants -->
		<select id="menu-time">
		</select>
	
		<script>		
			for (var i=0; i<dates_snapshots.length; i++) {
				var option = document.createElement("option");
				option.value = i;
				
				// FF does not support innerText, have to handle that separately
				if (typeof option.innerText === "undefined")
				{
					option.textContent = dates_snapshots[i].date;
				}
				else
				{
					option.innerText = dates_snapshots[i].date;
				}

				var select = document.getElementById("menu-time");
				select.appendChild(option);
			}		
		</script>		

	</div>
	</div>	
	
	<!-- The central visualization area -->
	<div id="map" class="center">
	<div class="container">	
		
		<script>

			// Set view around Stenlille
			var map = L.map('map').setView([55.546504, 11.600876], 13);
			
			var selectedSnapshot = 0;
			var snapshotLayer; 
			var latLngBounds;
			
			const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
				}).addTo(map);
				
			// Add scale
			L.control.scale({imperial: false}).addTo(map); 
			
			/*
			function onMapClick(e) {
				L.popup(e.latlng)
					.setContent(`You clicked the map at ${e.latlng.toString()}`)
					.openOn(map);
			}
			map.on('click', onMapClick);
			*/
				
			// Plot the wells
			let well_marker = []
			for (var i=0;i<wells.length;i++) {
				well_marker[i] = L.marker([wells[i].N_Degrees, wells[i].E_Degrees], { title: wells[i].Name }).addTo(map)
								.bindPopup(''.concat('<b>', wells[i].Name, '</b>')).openPopup();			
			}
			
			
			let img = new Image();
			img.onload = function() {
				img.width = this.width;
			    img.height = this.height;
						
				// This ratio is obtained by getting the pixel distance between ST-1 and ST-9 in GIMP,
				// and the distance in km between these wells in plot_stenlille.py
				img.px2km = 0.91 / 58;
						
				let imgWidthKm = img.width * img.px2km;
				let imgHeightKm = img.height * img.px2km;

				// Manually adjusted
				let nw = [55.569329, 11.537189];
				
				// Coordinates for the NE corner of the image
				//var A = L.marker(nw).addTo(map).bindPopup('<b>NW</b>').openPopup();
				let ne = destination(nw, 90, imgWidthKm * 1000);
				// L.marker(L.latLng(ne)).addTo(map);
				
				// Coordinates for the SE corner of the image
				let se = destination(ne, 180, imgHeightKm * 1000);
				// L.marker(L.latLng(se)).addTo(map);			

				// Set up the NW-SE bounding box
				latLngBounds = L.latLngBounds([nw, se]);
				
				//console.log(latLngBounds);				
				drawMap();

			}
			
			let fname = dates_snapshots[selectedSnapshot].snapshot;
			let image = "./stenlille/".concat(fname);	
			img.src = image;	
			
			// If another item is chosen on the menu-time
			$("#menu-time").change(function() {
				
			    // Remove the current solution snapshot
			    map.removeLayer(snapshotLayer);

				// Assign the index of the selected snapshot
				selectedSnapshot = $(this).val();
				
				console.log(selectedSnapshot);

				// Redraw the map 
				drawMap();
			});

			function drawMap() {
			
				let fname = dates_snapshots[selectedSnapshot].snapshot;
				let image = "./stenlille/".concat(fname);				

				snapshotLayer = L.imageOverlay(image, latLngBounds, {
					opacity: 0.7,
					interactive: true
				});
				
				// Draw the snapshot, corresponding to selectedSnapshot
				map.addLayer(snapshotLayer);
				
				/*
				// Make the snapshot draggable
				var draggable = new L.Draggable(snapshotLayer.getElement());
				draggable.enable();	
				*/
			}
		
		</script>	
	</div>
	</div>

	<!-- Footer -->
	<script src="./footer.js"></script>


</body>
</html>
